/*!
 * ==========================================================
 *  MARKDOWN TEXT EDITOR PLUGIN 1.4.3
 * ==========================================================
 * Author: Taufik Nurrohman <https://github.com/tovic>
 * License: MIT
 * ----------------------------------------------------------
 */
TE.ui.Markdown=function(e,t){function v(e){return b(e.replace(/\s+/g," "))}function k(e){return m(v(e),[/<.*?>/g,'"',"'","(",")","[","]"],["","&#34;","&#39;","&#40;","&#41;","&#91;","&#93;"])}function y(e){return m(v(e),[/<.*?>/g,/\s/g,'"',"(",")","[","]"],["","%20","%22","%28","%29","%5B","%5D"])}var n=TE.ui.HTML||TE.ui,r=n(e,{extra:0,auto_p:0,auto_close:{"`":"`","*":"*",_:"_","~":"~"},tools:"b i s | a img | note abbr | p,h1,h2,h3,h4,h5,h6 | blockquote,q pre,code | ul ol | indent outdent | table | hr | undo redo",states:{a:{"":[""]},img:{}},languages:{tools:{note:["Footnote","⌘+↓"]},modals:{a:{title:["Link URL/Reference ID"]},img:{title:["Image URL/Reference ID"]},note:{title:"Footnote ID"}}},advance_br:1,"advance_h1,h2":1,"advance_pre,code":1,"close_h1,h2,h3,h4,h5,h6":0,close_tr:0,formats:{b:["**","__"],i:["_","*"],s:["~~"],h1:["=","#"],h2:["-","##"],h3:["###"],h4:["####"],h5:["#####"],h6:["######"],blockquote:[">"],code:["`","~"],ul:["-","+","*"],ol:["%1."],hr:["---","+++","***"]}}),l=r.ui,i="	",s=TE.is,a=s.o,f=function(e){return!s.x(e)},o=s.s,c=r._,u=c.edge,p=c.x,h=c.extend,d=c.format,$=c.i,g=c.pattern,m=c.replace,b=c.trim;r.update(t,0),r.type="Markdown";var _=r.config,x=_.extra,w=_.formats,q=_.languages,T=_.states,O=_.tab,E=q.placeholders,S="( +["+p(w.ul).join("")+"] )",L=0;return x||(_["advance_pre,code"]=0),r.mark=function(e,t,n,l){a(e)||(e=[e]),f(n)||(n=" "),f(l)||(l="");var i=r.h,s=r[0]().$(),o=e[0]+l,c=l+(f(e[1])?e[1]:e[0]),u=s.value,h=p(o),d=p(c),$=g("^"+h+"([\\s\\S]*?)"+d+"$"),m=g(h+"$"),b=g("^"+d),v=s.before,k=s.after;return u?n=!1:r.insert(E[""]),r.toggle(t?!$.test(u):!m.test(v)&&!b.test(k),[function(e){e.unwrap(o,c,1).tidy(/<[^\/<>]+?>$/.test(v)?"":n,/^<\/[^<>]+?>/.test(k)?"":n).wrap(o,c,t)},function(e){e.unwrap(o,c,t)}])[i]()},h(l.tools,{clear:0,b:{click:function(e,t){return t.i().mark(w.b[0]),!1}},i:{click:function(e,t){return t.i().mark(w.i[0]),!1}},u:0,s:x?{click:function(e,t){return t.i().mark(w.s[0]),!1}}:0,a:{click:function(e,t){var p,h,d,$,g,m,v,n=t.$(),r=n.before,i=n.value,s=n.after,a=t.get(),f=/^ {0,3}\[[^\^]+?\]:/.test(a.split("\n").pop())?"\n":"\n\n",o=a.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],c=q.modals.a,u=c.placeholder[0];if(/^([a-z]+:\/\/\S+|<[a-z]+:\/\/\S+>)$/.test(i))return t.tidy(" ").mark(["<",">"],1),!1;for(v in o)v=" "+b(o[v]).replace(/^\[|\]:$/g,""),T.a[v]=1;return p=T.a,l.prompt(c.title[0],u,0,function(e,t,a){var v=""===a;a=y(a),t[0](),p[a]?(t.trim(b(r)?" ":"",/^\n+ {0,3}\*?\[/.test(s)?!1:" ").mark(["[","]["+a+"]"],0,!1),$=o.indexOf(" ["+a+"]:"),-1===$&&1!==p[a]&&(n=t.$(),r=n.before,g=n.start,m=n.end,t.set(r+(i||E[""])+b(n.after,1)+f+" ["+(a||b(i)||E[""])+"]: "+(v?"":p[a][0]+(p[a][1]?' "'+p[a][1]+'"':""))).select(g,m),v&&t.focus(1).insert(u))):(h=a,l.prompt(c.title[1],c.placeholder[1],0,function(e,t,n){d=k(n),i||t.insert(E[""]),t.i().trim(b(r)?" ":"",b(s)?/^\n+ {0,3}\*?\[/.test(s)?"\n\n ":" ":"").wrap("[","]("+h+(d?' "'+d+'"':"")+")")},0,0,"a[title]")),t[1]()},0,0,"a[href]").record(),!1}},img:{click:function(e,t){var h,d,$,g,m,v,_,n=t.$(),r=n.value,i=r,s=n.before,a=n.after,f=t.get(),o=/^ {0,3}\[[^\^]+?\]:/.test(f.split("\n").pop())?"\n":"\n\n",c=f.match(/^ {0,3}\[[^\^]+?\]:/gm)||[],u=q.modals.img,p=/^\n* {0,3}\*?\[.+?\]:/.test(a)?"\n\n ":"";for(_ in c)_=" "+b(c[_]).replace(/^\[|\]:$/g,""),!T.img[_]&&(T.img[_]=1);return h=T.img,l.prompt(u.title[0],u.placeholder[0],1,function(e,t,r){r=y(r),d=r,i||(i=d.split(/[\/\\\\]/).pop()),i=k(i),h[r]?(t[0]().trim(b(s)?"\n\n":"",p),t.insert("!["+i+"]["+r+"]\n\n",0,1),p&&t.select(t.$().start),g=c.indexOf(" ["+r+"]:"),-1===g&&(n=t.$(),s=n.before,m=n.start,v=n.end,t.set(s+n.after+o+" ["+r+"]: "+h[r][0]+(h[r][1]?' "'+h[r][1]+'"':"")).select(m,v))):l.prompt(u.title[1],u.placeholder[1],0,function(e,t,n){$=k(n),t[0]().trim(b(s)?"\n\n":"",p),t.insert("!["+i+"]("+d+($?' "'+$+'"':"")+")\n\n",0,1),p&&t.select(t.$().start)},0,0,"img[title]"),t[1]()},0,0,"img[src]"),!1}},sub:0,sup:0,abbr:x?{click:function(t,n){var r=n.$(),i=b(r.value),s=q.modals.abbr,a=n.get(),f=v(i||E[""]),o=/^ {0,3}\*\[.+?\]:/.test(a.split("\n").pop())?"\n":"\n\n",c=a.match(/^ {0,3}\*\[.+?\]:/gm)||[],u=T.abbr,p=0;for(p in c)c[p]=" "+b(c[p]);return p=c.indexOf(" *["+f+"]:"),i&&-1!==p?(p=a.indexOf(c[p])+3,n.select(p,p+f.length),e.scrollTop=n.$(1).caret[0].y,!1):(l.prompt(s.title,u[f]||s.placeholder,!u[i],function(e,t,n,l){if(n=k(n),t[0]().set(b(t.get(),1)+(r.before||i?o:"")+" *["+f+"]: ").focus(1).insert(n||l),f===E[""]){var s=t.$().start;t.select(s-3-f.length,s-3)}t[1]()},0,0,"abbr[title]").record(),!1)}}:0,p:{click:function(e,t){return t.$().length?(t.tidy("\n\n").replace(/([\t ]*\n[\t ]*){2,}/g,"\n\n"),!1):(t.tidy("\n\n").insert(E[""]).scroll(2),!1)}},br:{click:function(e,t){var n=_.advance_br;return!o(n)&&n&&(n="  \n"),t.trim().insert(n||"\n",0).scroll(1),!1}},"p,h1,h2,h3,h4,h5,h6":{click:function(e,t){L>5?L=0:L++;var n=t.$(),r=_["advance_h1,h2"],l="\\s?["+p(w.h1[0]+w.h2[0])+"]+\\s*",i=p(w.h1[1]),s=n.before.replace(g("["+i+"\\s]+$"),""),a=v(n.value).replace(g("^["+i+"\\s]+|["+i+"\\s]+$","g"),"").replace(g(l+"$"),"")||E[""],f=n.after.replace(g("^["+i+"\\s]+"),"").replace(g("^"+l),""),o=["",w.h1[r?0:1],w.h2[r?0:1],w.h3[0],w.h4[0],w.h5[0],w.h6[0]];return t[0]().set(s+a+f).select(s.length,(s+a).length).tidy("\n\n"),0===L||(3>L&&r?t.wrap("","\n"+a.replace(/./g,o[L])):t.wrap(o[L]+" ",_["close_h1,h2,h3,h4,h5,h6"]?" "+o[L]:"")),t[1](),!1}},"blockquote,q":{click:function(e,t){var n=t.$(),r=n.value,l=w.blockquote[0];return r===E[""]?(t.select(),!1):r?(t.tidy(g(l+" $").test(n.before)?!1:"\n\n")[g("^"+l).test(r)?"outdent":"indent"](l+" "),!1):(t[0]().tidy("\n\n").insert(l+" ",0).insert(E[""])[1](),!1)}},"pre,code":{click:function(e,t){var c,u,h,n=t.$(),r=n.before,l=n.value,s=_["advance_pre,code"],a=w.code,f=a[1]||a[0];return f=f+f+f,!o(s)&&s?s=f:o(s)&&-1!==s.indexOf("%")&&(s=d(s,[f])),c="( {4,}|\\t"+(o(s)?"|"+p(s):"")+")",g("(^|\\n)"+c+"?$").test(r)?s?(t.mark([s,s.split(/\s+/)[0]],0,"\n\n","\n"),!1):(s=O===i?i:"    ",l?l===E[""]&&g(c+"$").test(r)?(t.select(n.start-s.length,n.end),!1):(t.tidy("\n\n")[g("^"+c).test(l)?"outdent":"indent"](s),!1):(t[0]().tidy("\n\n"),u=t.$().start,h=s+E[""],t.insert(h).select(u+s.length,u+h.length)[1](),!1)):(t.mark(a[0]),!1)}},ul:{click:function(e,t){var b,n=t.$(),r=n.value,l=n.before,i=n.after,s=w.ul[0],a=w.ol[0],f=p(s),o=d(p(a),["\\d+"]),c=g("(^|\\n)([\\t ]*) "+f+" (.*)$"),u=g("^(.*) "+f+" ","gm"),h=g("(^|\\n)([\\t ]*) "+o+" (.*)$"),$=g("^(.*) "+o+" ","gm"),m=E[""];return r?(r===m?t.select():$.test(r)?t.replace($,"$1 "+s+" "):u.test(r)?t.replace(u,"$1"):t.replace(/^(\s*)(\S.*)$/gm,"$1 "+s+" $2"),!1):i&&l&&("\n"!==i[0]||"\n"!==l.slice(-1))?(b=h.test(l)?l.replace(h,"$1$2 "+s+" $3"):c.test(l)?l.replace(c,"$1$2$3"):l.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+s+" $3"),t.set(b+i).select(b.length),!1):(t[0]().tidy("\n\n").insert(" "+s+" ",0).insert(m)[1](),!1)}},ol:{click:function(e,t){var k,n=t.$(),r=n.value,l=n.before,i=n.after,s=w.ul[0],a=w.ol[0],f=d(a,[1]),o=p(s),c=d(p(a),["\\d+"]),u=g("(^|\\n)([\\t ]*) "+o+" (.*)$"),h=g("^(.*) "+o+" ","gm"),$=g("(^|\\n)([\\t ]*) "+c+" (.*)$"),m=g("^(.*) "+c+" ","gm"),b=E[""],v=0;return r?(r===b?t.select():h.test(r)?t.replace(h,function(e,t,n){return++v,t+" "+d(a,[v])+" "}):m.test(r)?t.replace(m,"$1"):t.replace(/^(\s*)(\S.*)$/gm,function(e,t,n){return++v,t+" "+d(a,[v])+" "+n}),!1):i&&l&&("\n"!==i[0]||"\n"!==l.slice(-1))?(k=u.test(l)?l.replace(u,"$1$2 "+f+" $3"):$.test(l)?l.replace($,"$1$2$3"):l.replace(/(^|\n)(\s*)([^\n]*)$/,"$1$2 "+f+" $3"),t.set(k+i).select(k.length),!1):(t[0]().tidy("\n\n").insert(" "+f+" ",0).insert(b)[1](),!1)}},table:x?function(e,t){var o,c,p,n=T.tr,r=T.td,i=q.modals.table,s=q.placeholders.table,a=d(s[0],[1,1]),f=[];return t[0]().$().value===a?(t.select(),!1):(l.prompt(i.title[0],i.placeholder[0],0,function(e,t,h,g){c=u($(h)||g,r[0],r[1]),l.prompt(i.title[1],i.placeholder[1],0,function(e,t,r,l){p=u($(r)||l,n[0],n[1]);var i,h,g,m,b,v;for(i=0;p>i;++i){for(o="|",h=0;c>h;++h)o+=" "+d(s[1],[i+1,h+1])+" |";f.push(o)}for(f=f.join("\n"),o="|",g=0;c>g;++g)o+=" "+d(s[0],[g+1,g+1]).replace(/./g,"-")+" |";for(f=o+"\n"+f,o="|",m=0;c>m;++m)o+=" "+d(s[0],[1,m+1])+" |";f=o+"\n"+f,_.close_tr||(f=f.replace(/^\|\s*|\s*\|$/gm,"")),t.tidy("\n\n").insert(f),b=t.$(),v=b.start+b.value.indexOf(a),t.select(v,v+a.length)[1]()},0,0,"table>tr")},0,0,"table>td"),!1)}:0,hr:{click:function(e,t){return t.tidy("\n\n","").insert(w.hr[0]+"\n\n",0).scroll(2),!1}},note:x?{click:function(t,n){var p,r=n.$(),i=r.before,s=r.after,a=q.modals.note,f=n.get(),o=/^ {0,3}\[\^.+?\]:/.test(f.split("\n").pop())?"\n":"\n\n",c=f.match(/^ {0,3}\[\^.+?\]:/gm)||[],u=0;for(u in c)c[u]=" "+b(c[u]);return u=c.length+1,l.prompt(a.title,r.value||u,0,function(t,n,r,l){r=b(r||l)||u,p=c.indexOf(" [^"+r+"]:"),-1!==p?(u=f.indexOf(c[p])+3,n.select(u,u+r.length),e.scrollTop=n.$(1).caret[0].y):n.trim(b(i)?" ":"",!b(s)||/^[\t ]*\n+[\t ]*/.test(s)?"\n\n ":" ").insert("[^"+r+"]").set(b(n.get(),1)+o+" [^"+r+"]: ").focus(1).insert(E[""])},0,0,"note[id]"),!1}}:0}),h(l.keys,{enter:function(e,t){var n=t.$(),r=E[""],l=w.blockquote[0],s=(w.ul[0],w.ol[0]),a=d(p(s),["\\d+"]),f="(("+p(l)+" )+|"+S+"| +("+a+") )",o=g("^"+f+".*$","gm").exec(n.before.split("\n").pop());if(o){if(o[0]===o[1])return t[0]().insert("").outdent(g(f))[1](),!1;if(g("\\s*"+a+"\\s*").test(o[1])){var c=$(b(o[1]));return t[0]().insert("\n"+o[1].replace(/\d+/,c+1),0).insert(r).scroll(1)[1](),!1}return t[0]().insert("\n"+o[1],0).insert(r).scroll(1)[1](),!1}},"shift+tab":function(e,t){var b,n=t.$(),r=n.before,i=n.value,s=n.after,a=E[""],f=w.ol[0],o=p(f),c=d(o,["\\d+"]),u=p(w.blockquote[0]),h=g("  "+S+"$"),$=g("   ( ?"+c+" )$"),m="("+u+" |"+S+"| +"+c+" )";if(i&&i!==a){if(i&&(b=i.match(g("(^|\\n)"+m,"g"))))return t.outdent(g(m)),!1}else{if(b=r.match(g(u+" $")))return t[0]().insert("").outdent(b[0]).insert(i)[1](),!1;if(b=r.match(h))return r=r.replace(h,"$1"),t.set(r+i+s).select(r.length,(r+i).length),!1;if(b=r.match($))return r=r.replace($,"$1"),t.set(r+i+s).select(r.length,(r+i).length),!1}return l.tools.outdent.click(e,t)},tab:function(e,t){var m,n=t.$(),r=n.before,i=n.value,s=n.after,a=E[""],f=w.ol[0],o=w.blockquote[0],c=p(f),u=p(o),h=g(S+"$"),$=g(" ?"+d(c,["\\d+"])+" $");if(i&&i!==a){if(g("^"+u+" ").test(i))return t.indent(o+" "),!1}else{if(m=r.match(g(u+" $")))return t.insert(m[0],0),!1;if(m=r.match(h))return r=r.replace(h,"  $1"),t.set(r+i+s).select(r.length,(r+i).length),!1;if(m=r.match($))return r=r.replace($,"    "+d(f,[1])+" "),t.set(r+i+s).select(r.length,(r+i).length),!1}return l.tools.indent.click(e,t)},"control+down":"note","control+up":"note"}),r.update({},0)};